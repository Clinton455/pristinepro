<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Booking</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f2f2f7;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .calendar-container {
            width: 100%;
            max-width: 375px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 20px;
        }
        .calendar-header {
            background-color: #556475;
            color: white;
            padding: 15px;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .calendar-header h2 {
            margin: 0;
            font-weight: 600;
        }
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        .nav-buttons button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            background-color: #f2f2f7;
            padding: 10px 0;
            font-weight: 500;
        }
        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            gap: 5px;
            padding: 10px;
        }
        .day {
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .day:hover {
            background-color: #e5e5ea;
        }
        .day.current-day {
            background-color: #adb4bd;
            color: white;
        }
        .day.other-month {
            color: #8e8e93;
        }
        .info-section {
            margin-top: 20px;
            text-align: center;
        }
        .info-section h1 {
            margin: 0;
            font-size: 24px;
            color: #556475;
        }
        .info-section p {
            margin: 10px 0;
            font-size: 18px;
        }
        .info-section button {
            display: none;
            padding: 10px 20px;
            background-color: #556475;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        #slotbook {
            display: none;
        }
        .selected-day {
            background-color: #556475;
            color: white;
        }
    </style>
</head>
<body>
    <div class="info-section">
        <h1>Book Your Appointment</h1>
    </div>
    <div class="calendar-container">
        <div class="calendar-header">
            <div class="nav-buttons">
                <button id="prevMonth">&lt;</button>
            </div>
            <h2 id="monthYear">June 2024</h2>
            <div class="nav-buttons">
                <button id="nextMonth">&gt;</button>
            </div>
        </div>
        <div class="weekdays">
            <div>Su</div>
            <div>Mo</div>
            <div>Tu</div>
            <div>We</div>
            <div>Th</div>
            <div>Fr</div>
            <div>Sa</div>
        </div>
        <div id="days" class="days">
            <!-- Days populated dynamically -->
        </div>
    </div>
    <div class="info-section">
        <p id="slotInfo">Slots Available</p>
        <p id="slotbook">Book Now before someone else reserves your spot!</p>
        <button id="bookNow">Book Now</button>
    </div>

    <script>
        const slotMessages = {
            1: "Free Slot Available",
            2: "Sorry No Slots Available for today! We are fully booked",
            3: "1 Slot Available! Please take it before it gets taken!",
            4: "Slot Available: 2",
            5: "Slot Available: 3",
            6: "Slot Available: 4"
        };
    
        const socket = new WebSocket('wss://https://pristinepro.onrender.com');
        let slotsData = {};
    
        class Calendar { 
            constructor() {
                this.currentDate = new Date();
                this.today = new Date();
                this.selectedDay = null;
                this.daysElement = document.getElementById('days');
                this.monthYearElement = document.getElementById('monthYear');
                this.slotInfoElement = document.getElementById('slotInfo');
                this.bookNowButton = document.getElementById('bookNow');
    
                document.getElementById('prevMonth').addEventListener('click', () => this.changeMonth(-1));
                document.getElementById('nextMonth').addEventListener('click', () => this.changeMonth(1));
    
                this.renderCalendar();
    
                //this.bookNowButton.addEventListener('click', () => {
                    /*if (this.selectedDay) {
                        const selectedDate = new Date(this.selectedDay.year, this.selectedDay.month, this.selectedDay.day);
                        const formattedDate = selectedDate.toISOString().split('T')[0]; // format as YYYY-MM-DD
                        const whatsappLink = `https://wa.me/27671689045?text=Hi,%20I%20would%20like%20to%20book%20an%20appointment%20for%20date%20${formattedDate}`;
                        window.open(whatsappLink, '_blank');
                    }*/
                //});
            }
    
            renderCalendar() {
                const firstDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1);
                const lastDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 0);
    
                this.monthYearElement.textContent = firstDay.toLocaleString('default', { month: 'long', year: 'numeric' });
                this.daysElement.innerHTML = '';
    
                const startingDay = firstDay.getDay();
                for (let i = 0; i < startingDay; i++) {
                    const dayElement = document.createElement('div');
                    dayElement.classList.add('day', 'other-month');
                    this.daysElement.appendChild(dayElement);
                }
    
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const dayElement = document.createElement('div');
                    dayElement.textContent = day;
                    dayElement.classList.add('day');
    
                    const dateKey = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), day).toISOString().split('T')[0];
                    if (slotsData[dateKey]) {
                        dayElement.dataset.slot = slotsData[dateKey];
                    }
    
                    if (
                        day === this.today.getDate() &&
                        this.currentDate.getMonth() === this.today.getMonth() &&
                        this.currentDate.getFullYear() === this.today.getFullYear()
                    ) {
                        dayElement.classList.add('current-day');
                    }
    
                    if (this.selectedDay && day === this.selectedDay.day && this.currentDate.getMonth() === this.selectedDay.month && this.currentDate.getFullYear() === this.selectedDay.year) {
                        dayElement.classList.add('selected-day');
                    }
    
                    dayElement.addEventListener('click', () => this.handleDaySelection(dateKey, day));
                    this.daysElement.appendChild(dayElement);
                }
            }
    
            handleDaySelection(dateKey, day) {
    const selectedDayElement = this.daysElement.querySelector('.day.selected-day');
    if (selectedDayElement) {
        selectedDayElement.classList.remove('selected-day');
    }

    // Store the selected day details
    this.selectedDay = {
        day: day,
        month: this.currentDate.getMonth(),
        year: this.currentDate.getFullYear()
    };

    // Determine the slot using slotsData
    const selectedSlot = slotsData[dateKey] || 1; // Default to 1 if no data for the date
    console.log(`Selected slot: ${selectedSlot}`); // Debugging log

    // Update slot information display
    this.slotInfoElement.textContent = slotMessages[selectedSlot];

    // Handle slot 2: Hide "Book Now" button and redirect
    if (selectedSlot==2) {
        this.bookNowButton.style.display = 'none';
        this.bookNowButton.onclick = () => {
            window.location.href = 'https://www.pristinepro.co.za';
        };
        return; // Exit the function for slot 2
    } else {
        // Display the "Book Now" button for all other slots
        this.bookNowButton.style.display = 'inline-block';
    }

    // Highlight the selected day
    const dayElements = this.daysElement.querySelectorAll('.day');
    dayElements.forEach(dayElem => dayElem.classList.remove('selected-day'));
    const selectedDayElem = [...dayElements].find(dayElem => dayElem.textContent == day && !dayElem.classList.contains('other-month'));
    if (selectedDayElem) selectedDayElem.classList.add('selected-day');

    // Create WhatsApp booking link for slots 1, 3, 4, 5, 6
    const fakeDate = new Date(this.selectedDay.year, this.selectedDay.month, this.selectedDay.day);
    fakeDate.setDate(fakeDate.getDate());

    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const monthName = monthNames[fakeDate.getMonth()];
    let dayWithSuffix = fakeDate.getDate();

    // Add ordinal suffix (st, nd, rd, th) to the day
    if (dayWithSuffix > 3 && dayWithSuffix < 21) {
        dayWithSuffix += "th";
    } else {
        const lastDigit = dayWithSuffix % 10;
        if (lastDigit === 1) {
            dayWithSuffix += "st";
        } else if (lastDigit === 2) {
            dayWithSuffix += "nd";
        } else if (lastDigit === 3) {
            dayWithSuffix += "rd";
        } else {
            dayWithSuffix += "th";
        }
    }

    const formattedFakeDate = `${fakeDate.getFullYear()} ${monthName} ${dayWithSuffix}`;
    const whatsappLink = `https://wa.me/27671689045?text=Hi,%20I%20would%20like%20to%20book%20an%20appointment%20for%20date%20${formattedFakeDate}`;

    // Assign WhatsApp link to "Book Now" button for other slots
    this.bookNowButton.onclick = () => {
        window.open(whatsappLink, '_blank');
    };
}

    
            changeMonth(increment) {
                this.currentDate.setMonth(this.currentDate.getMonth() + increment);
                this.renderCalendar();
            }
        }
    
        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'update') {
                slotsData = data.slots;
                new Calendar().renderCalendar();
            }
        };
    
        new Calendar();
    </script>
    
</body>
</html>
